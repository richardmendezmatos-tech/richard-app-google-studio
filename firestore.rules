rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- Collections ---

    // Car Inventory: Publicly readable for marketplace
    match /cars/{carId} {
      allow read: if true; 
      allow create, delete: if isAdmin();
      allow update: if (isAdmin()) || 
                    (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views', 'leads_count']));
    }
    
    // User Profiles
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if (isOwner(userId) && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']))) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Applications (Leads): Isolated by Dealer logic
    match /applications/{appId} {
      allow create: if true; 
      allow read, update, delete: if isAdmin() && 
                                     (resource == null || resource.data.dealerId == getUserData().dealerId);
    }

    // CRM Leads
    match /leads/{leadId} {
      allow create: if true;
      allow read, update, delete: if isAdmin() && 
                                     (resource == null || resource.data.dealerId == getUserData().dealerId);
    }

    // Customer Memory (Phase 6): Highly Sensitive
    match /customer_memory/{leadId} {
      allow read, write: if isAdmin() && 
                           (resource == null || resource.data.dealerId == getUserData().dealerId);
    }

    // WhatsApp Sequences (Phase 6): Autopilot Logic
    match /whatsapp_sequences/{leadId} {
      allow read, write: if isAdmin() && 
                           (resource == null || resource.data.dealerId == getUserData().dealerId);
    }

    // Secure PII Vault (Full SSN/Credit Reports)
    match /applications_secure/{appId} {
      allow create: if true; 
      allow read: if isAdmin() && 
                    (getUserData().superAdmin == true || getUserData().accessPII == true);
      allow update, delete: if false; 
    }

    // Audit Logs
    match /audit_logs/{id} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // Login Security
    match /login_attempts/{attemptId} {
      allow read: if isAdmin();
      allow create, update: if true;
      allow delete: if isAdmin();
    }
  }
}
